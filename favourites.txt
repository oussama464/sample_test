-- Show the sequence used by job.id (usually job_id_seq)
SELECT pg_get_serial_sequence('job', 'id') AS job_id_seq;

-- Resync it so the next generated id is > current max(id)
SELECT setval(
  pg_get_serial_sequence('job', 'id'),
  (SELECT COALESCE(MAX(id), 1) FROM job)
);


  -- Build SELECT list, replacing task_id only
  SELECT string_agg(
    CASE
      WHEN column_name = 'task_id'
        THEN format('replace(task_id, %L, %L) AS task_id', old_prefix, new_prefix)
      ELSE
        quote_ident(column_name)
    END,
    ', ' ORDER BY ordinal_position
  )
    INTO cols_select
  FROM information_schema.columns
  WHERE table_schema = 'public'
    AND table_name = 'task_instance';

  EXECUTE format(
    'INSERT INTO task_instance (%s)
     SELECT %s
     FROM task_instance
     WHERE dag_id = %L
       AND task_id LIKE %L
     ON CONFLICT DO NOTHING',
    cols, cols_select, v_dag, old_prefix || '%'
  );
END $$;


-- 2) Rewire dependent tables to the new task_id (now the parent exists)
UPDATE rendered_task_instance_fields
SET task_id = replace(task_id, 'ETLs.bonds.', 'ETLs.fxpm.')
WHERE dag_id = 'YOUR_DAG_ID_HERE'
  AND task_id LIKE 'ETLs.bonds.%';

UPDATE xcom
SET task_id = replace(task_id, 'ETLs.bonds.', 'ETLs.fxpm.')
WHERE dag_id = 'YOUR_DAG_ID_HERE'
  AND task_id LIKE 'ETLs.bonds.%';

UPDATE task_fail
SET task_id = replace(task_id, 'ETLs.bonds.', 'ETLs.fxpm.')
WHERE dag_id = 'YOUR_DAG_ID_HERE'
  AND task_id LIKE 'ETLs.bonds.%';

UPDATE task_reschedule
SET task_id = replace(task_id, 'ETLs.bonds.', 'ETLs.fxpm.')
WHERE dag_id = 'YOUR_DAG_ID_HERE'
  AND task_id LIKE 'ETLs.bonds.%';

-- Optional: Airflow UI event log table (nice to keep consistent)
UPDATE log
SET task_id = replace(task_id, 'ETLs.bonds.', 'ETLs.fxpm.')
WHERE dag_id = 'YOUR_DAG_ID_HERE'
  AND task_id LIKE 'ETLs.bonds.%';


-- 3) Remove old parent rows
DELETE FROM task_instance
WHERE dag_id = 'YOUR_DAG_ID_HERE'
  AND task_id LIKE 'ETLs.bonds.%';

COMMIT;

